<!DOCTYPE html>
<html>
<head>
    <title>Community Events Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        #map {
            height: 400px;
            width: 100%;
            margin-bottom: 20px;
        }
        .event-list {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ccc;
        }
        .event-item {
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        .event-item.next {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        .controls {
            margin: 20px 0;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="controls">
        <button onclick="showCurrentEvents()">Show Current Events</button>
        <button onclick="showNextEvents()">Show Next Events</button>
        <span id="currentTime"></span>
    </div>
    <div class="event-list" id="eventList"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        {% autoescape off %}
        const events = {{ events }};
        {% endautoescape %}
        // Initialize map
        const map = L.map('map').setView([53.37743855202611, -6.378832062945247], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        const markers = new L.LayerGroup().addTo(map);
        let currentMarkers = [];

        function addMarker(event, isNext = false) {
            const marker = L.marker([event.longitude, event.latitude])
                .bindPopup(`
                    <strong>${event.name}</strong><br>
                    Time: ${new Date(event.time).toLocaleString()}<br>
                    Duration: ${event.duration}<br>
                    ${isNext ? '<strong>Next Event!</strong>' : ''}
                `);
            currentMarkers.push(marker);
            markers.addLayer(marker);
        }

        function clearMarkers() {
            currentMarkers.forEach(marker => markers.removeLayer(marker));
            currentMarkers = [];
        }

        function updateEventList(events, nextEvent = null) {
            const eventList = document.getElementById('eventList');
            eventList.innerHTML = '';
            
            events.forEach(event => {
                const div = document.createElement('div');
                div.className = 'event-item' + (event === nextEvent ? ' next' : '');
                div.innerHTML = `
                    <strong>${event.name}</strong><br>
                    Time: ${new Date(event.time).toLocaleString()}<br>
                    Duration: ${event.duration}
                    ${event === nextEvent ? '<br><strong>Next Event!</strong>' : ''}
                `;
                eventList.appendChild(div);
            });
        }

        function showCurrentEvents() {
            const now = new Date();
            document.getElementById('currentTime').textContent = `Current Time: ${now.toLocaleString()}`;
            
            clearMarkers();
            const currentEvents = events.filter(event => new Date(event.time) <= now);
            currentEvents.forEach(event => addMarker(event));
            updateEventList(currentEvents);
        }

        function showNextEvents() {
            const now = new Date();
            document.getElementById('currentTime').textContent = `Current Time: ${now.toLocaleString()}`;
            
            clearMarkers();
            const futureEvents = events.filter(event => new Date(event.time) > now)
                .sort((a, b) => new Date(a.time) - new Date(b.time));
            
            if (futureEvents.length > 0) {
                const nextEvent = futureEvents[0];
                addMarker(nextEvent, true);
                updateEventList(futureEvents, nextEvent);
            } else {
                updateEventList([], null);
            }
        }

        // Initialize with current events
        showCurrentEvents();
        
        // Update every minute
        setInterval(showCurrentEvents, 60000);
    </script>
</body>
</html>