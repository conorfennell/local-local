<!DOCTYPE html>
<html>
<head>
    <title>Community Events Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        #map {
            height: 600px;
            width: 100%;
            margin-bottom: 20px;
        }
        .event-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ccc;
        }
        .event-item {
            padding: 15px;
            margin: 8px 0;
            border: 1px solid #eee;
            border-radius: 4px;
            background: #fff;
        }
        .event-item.next {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 4px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #2196f3;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #1976d2;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="controls">
        <button onclick="showCurrentEvents()">Show Current Events</button>
        <button onclick="showNextEvents()">Show Next Events</button>
        <span id="currentTime"></span>
    </div>
    <div class="event-list" id="eventList"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        {% autoescape off %}
        const events = {{ events }};
        {% endautoescape %}
        // Initialize map
        const map = L.map('map').setView([53.37743855202611, -6.378832062945247], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        const markers = L.layerGroup().addTo(map);

        function parseISO8601Duration(duration) {
            if (duration === "Unknown") return "Duration unknown";
            const matches = duration.match(/PT(\d+H)?(\d+M)?/);
            if (!matches) return duration;
            
            const hours = matches[1] ? parseInt(matches[1]) : 0;
            const minutes = matches[2] ? parseInt(matches[2]) : 0;
            
            let result = [];
            if (hours) result.push(`${hours} hour${hours > 1 ? 's' : ''}`);
            if (minutes) result.push(`${minutes} minute${minutes > 1 ? 's' : ''}`);
            
            return result.join(' and ');
        }

        function formatEventTime(timeString) {
            try {
                const date = new Date(timeString);
                if (isNaN(date.getTime())) return 'Invalid time';
                return date.toLocaleString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: 'numeric',
                    hour12: true
                });
            } catch (e) {
                return 'Invalid time';
            }
        }

        function clearMarkers() {
            markers.clearLayers();
        }

        function addMarker(event, isNext = false) {
            // Check if coordinates are valid
            if (!event.longitude || !event.latitude || 
                Math.abs(event.longitude) > 90 || Math.abs(event.latitude) > 180) {
                console.error('Invalid coordinates for event:', event.name);
                return;
            }

            const marker = L.marker([event.longitude, event.latitude])
                .bindPopup(`
                    <strong>${event.name}</strong><br>
                    Time: ${formatEventTime(event.start_time)}<br>
                    Duration: ${parseISO8601Duration(event.duration)}<br>
                    ${isNext ? '<strong>Next Event!</strong>' : ''}
                `);
            markers.addLayer(marker);
        }

        function createEventElement(event, isNext = false) {
            const div = document.createElement('div');
            div.className = 'event-item' + (isNext ? ' next' : '');
            
            // Filter out events with empty names
            if (!event.name.trim()) return null;

            div.innerHTML = `
                <strong>${event.name}</strong><br>
                Time: ${formatEventTime(event.start_time)}<br>
                Duration: ${parseISO8601Duration(event.duration)}
                ${isNext ? '<br><strong>Next Event!</strong>' : ''}
            `;
            return div;
        }

        function updateEventList(events, nextEvent = null) {
            const eventList = document.getElementById('eventList');
            eventList.innerHTML = '';
            
            if (events.length === 0) {
                eventList.innerHTML = '<div class="event-item">No events found</div>';
                return;
            }

            events.forEach(event => {
                const eventElement = createEventElement(event, event === nextEvent);
                if (eventElement) eventList.appendChild(eventElement);
            });
        }

        function filterValidEvents(events) {
            return events.filter(event => {
                const eventTime = new Date(event.start_time);
                return !isNaN(eventTime.getTime()) && // Valid date
                       event.name.trim() && // Has a name
                       event.start_time.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}Z$/); // Valid ISO format
            });
        }

        function showCurrentEvents() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 
                `Current Time: ${now.toLocaleString()}`;
            
            clearMarkers();
            const validEvents = filterValidEvents(events);
            const currentEvents = validEvents.filter(event => {
                const eventTime = new Date(event.start_time);
                const endTime = new Date(eventTime.getTime() + parseDuration(event.duration));
                return eventTime <= now && endTime >= now;
            });

            currentEvents.forEach(event => addMarker(event));
            updateEventList(currentEvents);
        }

        function parseDuration(duration) {
            if (duration === "Unknown") return 3600000; // Default 1 hour
            const matches = duration.match(/PT(\d+H)?(\d+M)?/);
            if (!matches) return 3600000;
            
            const hours = matches[1] ? parseInt(matches[1]) : 0;
            const minutes = matches[2] ? parseInt(matches[2]) : 0;
            
            return (hours * 3600000) + (minutes * 60000);
        }

        function showNextEvents() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 
                `Current Time: ${now.toLocaleString()}`;
            
            clearMarkers();
            const validEvents = filterValidEvents(events);
            const futureEvents = validEvents
                .filter(event => new Date(event.start_time) > now)
                .sort((a, b) => new Date(a.start_time) - new Date(b.start_time));
            
            if (futureEvents.length > 0) {
                const nextEvent = futureEvents[0];
                addMarker(nextEvent, true);
                updateEventList(futureEvents, nextEvent);
            } else {
                updateEventList([], null);
            }
        }

        // Initialize with current events
        showCurrentEvents();
        
        // Update every minute
        setInterval(showCurrentEvents, 60000);
    </script>
</body>
</html>