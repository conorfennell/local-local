<!DOCTYPE html>
<html>
<head>
    <title>Community Events Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        #map {
            height: 600px;
            width: 100%;
            margin-bottom: 20px;
        }
        .event-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ccc;
        }
        .event-item {
            padding: 15px;
            margin: 8px 0;
            border: 1px solid #eee;
            border-radius: 4px;
            background: #fff;
        }
        .event-item.next {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 4px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #2196f3;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #1976d2;
        }
        .location-header {
            font-weight: bold;
            margin-top: 15px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="controls">
        <button onclick="showCurrentEvents()">Show Current Events</button>
        <button onclick="showNextEvents()">Show Next Events</button>
        <span id="currentTime"></span>
    </div>
    <div class="event-list" id="eventList"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        {% autoescape off %}
        const events = {{ events }};
        {% endautoescape %}
        
        // Initialize map
        const map = L.map('map').setView([53.37743855202611, -6.378832062945247], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        const markers = L.layerGroup().addTo(map);

        function formatEventTime(timeString) {
            try {
                const date = new Date(timeString);
                if (isNaN(date.getTime())) return 'Invalid time';
                return date.toLocaleString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: 'numeric',
                    hour12: true
                });
            } catch (e) {
                return 'Invalid time';
            }
        }

        function clearMarkers() {
            markers.clearLayers();
        }

        function addLocationMarker(location, events) {
            console.log("Adding marker at:", location);
            const marker = L.marker([location.lat, location.lng])
                .bindPopup(
                    events.map(event => `
                        <strong>${event.name}</strong><br>
                        ${formatEventTime(event.start_time)}<br>
                    `).join('<hr>')
                );
            markers.addLayer(marker);
        }

        function showNextEvents() {
    const now = new Date();
    document.getElementById('currentTime').textContent = 
        `Current Time: ${now.toLocaleString()}`;
    
    clearMarkers();
    
    // Group future events by location
    const futureLocations = {};
    events.forEach(event => {
        const eventTime = new Date(event.start_time);
        if (eventTime > now) {
            // Swap the order here to match correct mapping format
            const key = `${event.longitude},${event.latitude}`;
            if (!futureLocations[key]) {
                futureLocations[key] = {
                    lat: event.longitude, // This is actually the latitude
                    lng: event.latitude,  // This is actually the longitude
                    events: []
                };
            }
            futureLocations[key].events.push(event);
        }
    });

    // Sort events at each location by time
    Object.values(futureLocations).forEach(location => {
        location.events.sort((a, b) => 
            new Date(a.start_time) - new Date(b.start_time)
        );
    });

    // Add markers for each location
    Object.values(futureLocations).forEach(location => {
        // When adding the marker, use the correct order
        const marker = L.marker([location.lat, location.lng])
            .bindPopup(
                location.events.map(event => `
                    <strong>${event.name}</strong><br>
                    ${formatEventTime(event.start_time)}<br>
                `).join('<hr>')
            );
        markers.addLayer(marker);
    });

    // Update event list
    updateEventList(Object.values(futureLocations));
}

// Do the same fix for showCurrentEvents
function showCurrentEvents() {
    const now = new Date();
    document.getElementById('currentTime').textContent = 
        `Current Time: ${now.toLocaleString()}`;
    
    clearMarkers();
    
    // Group current events by location
    const currentLocations = {};
    events.forEach(event => {
        const eventTime = new Date(event.start_time);
        if (eventTime <= now) {
            const key = `${event.longitude},${event.latitude}`;
            if (!currentLocations[key]) {
                currentLocations[key] = {
                    lat: event.longitude,
                    lng: event.latitude,
                    events: []
                };
            }
            currentLocations[key].events.push(event);
        }
    });

    // Add markers for each location
    Object.values(currentLocations).forEach(location => {
        const marker = L.marker([location.lat, location.lng])
            .bindPopup(
                location.events.map(event => `
                    <strong>${event.name}</strong><br>
                    ${formatEventTime(event.start_time)}<br>
                `).join('<hr>')
            );
        markers.addLayer(marker);
    });

    // Update event list
    updateEventList(Object.values(currentLocations));
}

        function updateEventList(locations) {
            const eventList = document.getElementById('eventList');
            eventList.innerHTML = '';
            
            if (locations.length === 0) {
                eventList.innerHTML = '<div class="event-item">No events found</div>';
                return;
            }

            locations.forEach(location => {
                const locationHeader = document.createElement('div');
                locationHeader.className = 'location-header';
                locationHeader.textContent = `Location (${location.lat}, ${location.lng})`;
                eventList.appendChild(locationHeader);

                location.events.forEach(event => {
                    const div = document.createElement('div');
                    div.className = 'event-item';
                    div.innerHTML = `
                        <strong>${event.name}</strong><br>
                        Time: ${formatEventTime(event.start_time)}
                    `;
                    eventList.appendChild(div);
                });
            });
        }

        // Initialize with current events
        showCurrentEvents();
        
        // Update every minute
        setInterval(showCurrentEvents, 60000);
    </script>
</body>
</html>